{"version":3,"file":"Popover.js","sourceRoot":"","sources":["../src/Popover.tsx"],"names":[],"mappings":"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","sourcesContent":["import {\n  useRef,\n  useLayoutEffect,\n  useState,\n  useCallback,\n  useEffect,\n  forwardRef,\n  cloneElement,\n  Ref,\n} from 'react';\nimport { PopoverPortal } from './PopoverPortal';\nimport { PopoverPosition, PopoverProps, PopoverState } from '.';\nimport { EMPTY_RECT, rectsAreEqual } from './util';\nimport { usePopover } from './usePopover';\nimport { useMemoizedArray } from './useMemoizedArray';\nexport { useArrowContainer } from './useArrowContainer';\nexport { ArrowContainer } from './ArrowContainer';\nexport { usePopover };\n\nconst DEFAULT_POSITIONS: PopoverPosition[] = ['top', 'left', 'right', 'bottom'];\n\nconst PopoverInternal = forwardRef(\n  (\n    {\n      isOpen,\n      children,\n      content,\n      positions: externalPositions = DEFAULT_POSITIONS,\n      align = 'center',\n      padding = 0,\n      reposition = true,\n      parentElement = window.document.body,\n      boundaryElement = parentElement,\n      containerClassName,\n      containerStyle,\n      transform,\n      transformMode = 'absolute',\n      boundaryInset = 0,\n      onClickOutside,\n      clickOutsideCapture = false,\n    }: PopoverProps,\n    externalRef: Ref<HTMLElement>,\n  ) => {\n    const positions = useMemoizedArray(\n      Array.isArray(externalPositions) ? externalPositions : [externalPositions],\n    );\n\n    // TODO: factor prevs out into a custom prevs hook\n    const prevIsOpen = useRef(false);\n    const prevPositions = useRef<PopoverPosition[] | undefined>();\n    const prevReposition = useRef(reposition);\n\n    const childRef = useRef<HTMLElement | undefined>();\n\n    const [popoverState, setPopoverState] = useState<PopoverState>({\n      align,\n      nudgedLeft: 0,\n      nudgedTop: 0,\n      position: positions[0],\n      padding,\n      childRect: EMPTY_RECT,\n      popoverRect: EMPTY_RECT,\n      parentRect: EMPTY_RECT,\n      boundaryRect: EMPTY_RECT,\n      boundaryInset,\n      violations: EMPTY_RECT,\n      hasViolations: false,\n    });\n\n    const onPositionPopover = useCallback(\n      (popoverState: PopoverState) => setPopoverState(popoverState),\n      [],\n    );\n\n    const { positionPopover, popoverRef, scoutRef } = usePopover({\n      isOpen,\n      childRef,\n      containerClassName,\n      parentElement,\n      boundaryElement,\n      transform,\n      transformMode,\n      positions,\n      align,\n      padding,\n      boundaryInset,\n      reposition,\n      onPositionPopover,\n    });\n\n    useLayoutEffect(() => {\n      let shouldUpdate = true;\n      const updatePopover = () => {\n        if (isOpen && shouldUpdate) {\n          const childRect = childRef?.current?.getBoundingClientRect();\n          const popoverRect = popoverRef?.current?.getBoundingClientRect();\n          if (\n            childRect != null &&\n            popoverRect != null &&\n            (!rectsAreEqual(childRect, popoverState.childRect) ||\n              popoverRect.width !== popoverState.popoverRect.width ||\n              popoverRect.height !== popoverState.popoverRect.height ||\n              popoverState.padding !== padding ||\n              popoverState.align !== align ||\n              positions !== prevPositions.current ||\n              reposition !== prevReposition.current)\n          ) {\n            positionPopover();\n          }\n\n          // TODO: factor prev checks out into the custom prevs hook\n          if (positions !== prevPositions.current) {\n            prevPositions.current = positions;\n          }\n          if (reposition !== prevReposition.current) {\n            prevReposition.current = reposition;\n          }\n\n          if (shouldUpdate) {\n            window.requestAnimationFrame(updatePopover);\n          }\n        }\n\n        prevIsOpen.current = isOpen;\n      };\n\n      window.requestAnimationFrame(updatePopover);\n\n      return () => {\n        shouldUpdate = false;\n      };\n    }, [\n      align,\n      isOpen,\n      padding,\n      popoverRef,\n      popoverState.align,\n      popoverState.childRect,\n      popoverState.padding,\n      popoverState.popoverRect.height,\n      popoverState.popoverRect.width,\n      positionPopover,\n      positions,\n      reposition,\n    ]);\n\n    useEffect(() => {\n      const popoverElement = popoverRef.current;\n\n      Object.assign(popoverElement.style, containerStyle);\n\n      return () => {\n        Object.keys(containerStyle ?? {}).forEach(\n          (key) =>\n            delete popoverElement.style[\n              key as keyof Omit<typeof containerStyle, 'length' | 'parentRule'>\n            ],\n        );\n      };\n    }, [containerStyle, isOpen, popoverRef]);\n\n    const handleOnClickOutside = useCallback(\n      (e: MouseEvent) => {\n        if (\n          isOpen &&\n          !popoverRef.current?.contains(e.target as Node) &&\n          !childRef.current?.contains(e.target as Node)\n        ) {\n          onClickOutside?.(e);\n        }\n      },\n      [isOpen, onClickOutside, popoverRef],\n    );\n\n    const handleWindowResize = useCallback(() => {\n      if (childRef.current) {\n        window.requestAnimationFrame(() => positionPopover());\n      }\n    }, [positionPopover]);\n\n    useEffect(() => {\n      const body = parentElement.ownerDocument.body;\n      body.addEventListener('click', handleOnClickOutside, clickOutsideCapture);\n      body.addEventListener('contextmenu', handleOnClickOutside, clickOutsideCapture);\n      body.addEventListener('resize', handleWindowResize);\n      return () => {\n        body.removeEventListener('click', handleOnClickOutside, clickOutsideCapture);\n        body.removeEventListener('contextmenu', handleOnClickOutside, clickOutsideCapture);\n        body.removeEventListener('resize', handleWindowResize);\n      };\n    }, [clickOutsideCapture, handleOnClickOutside, handleWindowResize, parentElement]);\n\n    const handleRef = useCallback(\n      (node: HTMLElement) => {\n        childRef.current = node;\n        if (externalRef != null) {\n          if (typeof externalRef === 'object') {\n            (externalRef as React.MutableRefObject<HTMLElement>).current = node;\n          } else if (typeof externalRef === 'function') {\n            (externalRef as (instance: HTMLElement) => void)(node);\n          }\n        }\n      },\n      [externalRef],\n    );\n\n    const renderChild = () => cloneElement(children, { ref: handleRef });\n\n    const renderPopover = () => {\n      if (!isOpen) return null;\n      return (\n        <PopoverPortal\n          element={popoverRef.current}\n          scoutElement={scoutRef.current}\n          container={parentElement}\n        >\n          {typeof content === 'function' ? content(popoverState) : content}\n        </PopoverPortal>\n      );\n    };\n\n    return (\n      <>\n        {renderChild()}\n        {renderPopover()}\n      </>\n    );\n  },\n);\n\nexport const Popover = forwardRef<HTMLElement, PopoverProps>((props, ref) => {\n  if (typeof window === 'undefined') return props.children;\n  return <PopoverInternal {...props} ref={ref} />;\n});\n"]}